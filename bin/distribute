#!/usr/bin/env bash

function distribute() {
  local output_dir=out
  local github_token=${GITHUB_TOKEN:-}
  local github_user=${GITHUB_USER:-}
  local args=()
  while [[ -n "$1" ]]; do
    case "$1" in
      --output-dir | -o )
        output_dir="$2"
        shift
        ;;
      --token )
        github_token="$2"
        shift
        ;;
      --user )
        github_user="$2"
        shift
        ;;
      * )
        args+=("$1")
        ;;
    esac
    shift
  done

  set -- ${args[@]}

  local version="$1"

  git checkout --orphan dist/$version
  git rm -rf .

  local tmpdir="$(mktemp -d)"
  mv .git/ out/ $tmpdir
  find . ! -name '.' ! -name '..' -delete
  mv $tmpdir/.git/ $tmpdir/out/* .

  git add .
  git commit -m "Distribution for $version"

  local push_cmd="git push origin dist/$version"
  if [[ -n "$github_user" && -n "$github_token" ]]; then
    $push_cmd < <(echo "$github_user"; echo "$github_token")
  else
    $push_cmd
  fi
}

if [[ ${BASH_SOURCE[0]} != $0 ]]; then
  export -f distribute
else
  set -eo pipefail

  distribute "${@:-}"
  exit $?
fi
